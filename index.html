<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🐱 해결냥냥이 고양치 – 스킨/사운드/낮밤/파티클</title>
<style>
  :root{
    /* Day colors */
    --day1:#a1c4fd; --day2:#c2e9fb;
    /* Night colors */
    --night1:#232526; --night2:#414345;
    --card:#fff; --txt:#333; --sub:#555;
    --btn1:#ff9a9e; --btn2:#fecfef; --ok:#6dd5ed; --warn:#ffd166; --bad:#ef476f;
  }
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(135deg,var(--day1),var(--day2));
    font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif; color:var(--txt);
    padding:24px; text-align:center; transition:background .6s ease;
    overflow-x:hidden; position:relative;
  }
  .stars{pointer-events:none; position:fixed; inset:0; opacity:0; transition:opacity .8s ease;}
  .star{position:absolute; width:2px; height:2px; background:#fff; border-radius:50%; opacity:.85}
  .is-night .stars{opacity:.65;}

  .app{background:var(--card); width:min(860px,94vw); border-radius:24px; box-shadow:0 10px 28px rgba(0,0,0,.15); padding:18px 16px}
  header{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:6px}
  h1{margin:6px 0 2px; font-size:1.5rem}
  .sub{color:var(--sub); font-size:.92rem; margin:2px 0 14px}
  .ctrls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center}
  select, .chip{
    border:1px solid #e5e7eb; padding:8px 10px; border-radius:999px; background:#fff; font-weight:600;
  }
  .chip{cursor:pointer; user-select:none}
  .chip.active{background:linear-gradient(135deg,var(--btn1),var(--btn2)); border-color:transparent}

  .row{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:10px 0}
  button{
    border:0; padding:12px 16px; border-radius:999px; cursor:pointer; font-weight:700;
    background:linear-gradient(135deg,var(--btn1),var(--btn2)); color:#333; box-shadow:0 6px 14px rgba(0,0,0,.12); transition:transform .08s ease;
  }
  button:active{transform:translateY(1px)}
  .small{padding:8px 12px; font-weight:600; opacity:.9}
  .pill{background:linear-gradient(135deg,#d4fc79,#96e6a1)}
  .warn{background:linear-gradient(135deg,#ffd166,#ffe29a)}
  .danger{background:linear-gradient(135deg,#ef476f,#ff8fab); color:#fff}

  .pet{
    position:relative;
    display:flex; gap:14px; align-items:center; justify-content:center; padding:12px 10px; border-radius:18px;
    background:linear-gradient(180deg,#ffffff, #f7fbff); box-shadow:inset 0 1px 0 rgba(0,0,0,.04);
  }
  .avatar{width:110px; height:110px; display:grid; place-items:center; position:relative; overflow:visible}
  .face{font-size:3.6rem; line-height:1}
  .svgcat{width:110px; height:110px}
  .name{font-weight:700; font-size:1.05rem}
  .hint{font-size:.9rem; color:#666}

  .bars{display:grid; gap:10px; margin:14px 0}
  .bar{display:grid; grid-template-columns:92px 1fr auto; align-items:center; gap:8px; font-size:.95rem}
  .track{height:12px; background:#edf2f7; border-radius:999px; overflow:hidden}
  .fill{height:100%; width:50%; background:linear-gradient(90deg,var(--btn1),var(--btn2))}
  .val{min-width:56px; text-align:right; font-variant-numeric:tabular-nums}

  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  .card{background:#fff; border-radius:16px; padding:12px 14px; box-shadow:0 4px 10px rgba(0,0,0,.06)}
  @media(min-width:760px){ .grid{grid-template-columns:1fr 1fr}}

  #intro{font-size:1.05rem; color:#444; margin:6px 0 14px; line-height:1.6; font-style:italic; opacity:.9}

  #advice{min-height:1.6em; font-weight:700; transition:opacity .25s ease, transform .25s ease}
  .fade-in{opacity:1; transform:translateY(0)}
  .fade-out{opacity:0; transform:translateY(4px)}
  .footer{margin-top:10px; font-size:.85rem; color:#666}

  /* 파티클 */
  .particle{
    position:absolute; pointer-events:none; user-select:none; font-size:1.4rem; will-change:transform, opacity;
    animation: rise 800ms ease-out forwards;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.15));
  }
  @keyframes rise{
    0%{transform:translate(0,0) scale(1); opacity:1}
    100%{transform:translate(var(--dx, 10px), var(--dy, -60px)) scale(0.8); opacity:0}
  }
</style>
</head>
<body>
  <div class="stars" aria-hidden="true" id="stars"></div>

  <div class="app">
    <header>
      <div style="text-align:left">
        <h1>🐱 해결냥냥이 고양치</h1>
        <div class="sub">브라우저에 자동 저장! 같은 기기/브라우저에서 이어서 놀 수 있어요.</div>
      </div>
      <div class="ctrls">
        <select id="skinSelect" title="스킨 선택">
          <option value="emoji">스킨: 이모지</option>
          <option value="simple">스킨: 심플 고양이</option>
          <option value="chonky">스킨: 통통 고양이</option>
        </select>
        <select id="themeSelect" title="테마 선택">
          <option value="auto">테마: 자동</option>
          <option value="day">테마: 주간</option>
          <option value="night">테마: 야간</option>
        </select>
        <div id="soundChip" class="chip active" role="button" aria-pressed="true">🔊 사운드 ON</div>
      </div>
    </header>

    <p id="intro">
      마음속으로 고민이나 질문을 떠올린 뒤,<br>
      천천히 버튼을 눌러보세요.<br><br>
      📖 신비로운 해결 냥냥이가<br>
      오늘의 조언을 전해드립니다… ✨
    </p>

    <div class="pet">
      <div class="avatar" id="avatar">
        <div class="face" id="face">😺</div>
      </div>
      <div>
        <div class="name" id="petName">냥냥이</div>
        <div class="hint" id="statusLine">기분 좋은 가르랑 소리가 들려요 😺</div>
      </div>
    </div>

    <div class="bars">
      <div class="bar">
        <div>배고픔</div>
        <div class="track"><div class="fill" id="barHunger"></div></div>
        <div class="val" id="valHunger">60</div>
      </div>
      <div class="bar">
        <div>행복</div>
        <div class="track"><div class="fill" id="barHappy"></div></div>
        <div class="val" id="valHappy">60</div>
      </div>
      <div class="bar">
        <div>에너지</div>
        <div class="track"><div class="fill" id="barEnergy"></div></div>
        <div class="val" id="valEnergy">60</div>
      </div>
      <div class="bar">
        <div>레벨</div>
        <div class="track"><div class="fill" id="barXP" style="background:linear-gradient(90deg,#6dd5ed,#2193b0)"></div></div>
        <div class="val" id="valLevel">Lv 1</div>
      </div>
    </div>

    <div class="row">
      <button onclick="feed()">🍚 밥 주기</button>
      <button class="pill" onclick="play()">🎾 놀아주기</button>
      <button class="warn" onclick="sleep()">🛏️ 재우기</button>
      <button class="small" onclick="renamePet()">✏️ 이름</button>
      <button class="small" onclick="drawAdvice()">📖 조언</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hint">조언은 중복 없이 랜덤으로 나와요. 모두 소진되면 다시 섞어요.</div>
        <div id="advice" class="fade-in" style="margin-top:8px;"></div>
      </div>
      <div class="card">
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center">
          <button class="small" onclick="resetPet()">🔄 초기화</button>
          <button class="small" onclick="exportSave()">💾 내보내기</button>
          <button class="small" onclick="importSave()">📂 불러오기</button>
        </div>
        <textarea id="saveArea" placeholder="내보내기하면 저장 데이터가 여기에 표시돼요. 불러오기는 여기에 붙여넣고 실행!"></textarea>
      </div>
    </div>

    <div class="footer">저장은 이 기기/브라우저에만 유지됩니다. 다른 곳에서도 이어하려면 내보내기/불러오기를 사용하세요.</div>
  </div>

<script>
/* ===================== 저장/상태 ===================== */
const STORAGE_KEY = "nyang_tama_v3";
const defaultState = () => ({
  name: "냥냥이",
  hunger: 60, happy: 60, energy: 60,
  xp: 0, level: 1,
  last: Date.now(),
  advicePool: [],
  settings: { skin:"emoji", theme:"auto", sound:true }
});
let S = load();
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const obj = JSON.parse(raw);
    return { ...defaultState(), ...obj, settings:{...defaultState().settings, ...(obj.settings||{})}};
  }catch(e){ return defaultState(); }
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(S)); }

/* ===================== 시간 경과(오프라인) ===================== */
function applyTimeDecay(){
  const now = Date.now();
  const dtMin = Math.floor((now - (S.last||now))/60000);
  if(dtMin>0){
    const steps = Math.floor(dtMin/10); // 10분마다 1씩 감소
    if(steps>0){
      change("hunger",-steps);
      change("happy",-steps);
      change("energy",-steps);
    }
    S.last = now; save();
  }
}

/* ===================== 유틸/사운드 ===================== */
function clamp(v){ return Math.max(0, Math.min(100, v)); }
function change(k, dv){ S[k] = clamp((S[k]??0) + dv); }
function avgStat(){ return (S.hunger+S.happy+S.energy)/3; }
function stage(){ return S.level>=10 ? "boss" : S.level>=5 ? "adult" : "kitten"; }

function gainXP(n=6){
  S.xp += n;
  while(S.xp>=100){
    S.xp-=100; S.level++;
    toast(`레벨 업! 🎉 Lv ${S.level}`); playTone([880,1175,1568], 0.06);
  }
}

/* ---- WebAudio: beep + purr(그르릉) ---- */
let AC, masterGain, purrNode=null, purrGain=null;
function ensureAudio(){
  if(!S.settings.sound) return;
  if(!AC){
    AC = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = AC.createGain(); masterGain.gain.value=0.16; masterGain.connect(AC.destination);
  }
}
function beep(freq=440, dur=0.12){
  if(!S.settings.sound) return;
  ensureAudio();
  const o=AC.createOscillator(), g=AC.createGain();
  o.type="sine"; o.frequency.value=freq;
  g.gain.value=0.0001; o.connect(g); g.connect(masterGain);
  const now=AC.currentTime;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.linearRampToValueAtTime(0.5, now+dur*0.15);
  g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
  o.start(now); o.stop(now+dur);
}
function playTone(freqs=[660,550,440], step=0.1){
  let t=0;
  freqs.forEach(f=>{ setTimeout(()=>beep(f, step), t*1000); t+=step*0.9; });
}
function startPurr(){
  if(!S.settings.sound) return;
  ensureAudio();
  if(purrNode) return; // already
  // 저주파 톤 + 진폭 변조로 그르릉 구현
  const osc = AC.createOscillator(); // base rumble
  osc.type = "triangle"; osc.frequency.value = 45; // 저주파
  const lfo = AC.createOscillator(); // 사이드 LFO
  lfo.type = "sine"; lfo.frequency.value = 23;

  const g = AC.createGain(); g.gain.value = 0.0; // 시작 0
  const lfoGain = AC.createGain(); lfoGain.gain.value = 0.35; // 떨림 깊이
  lfo.connect(lfoGain); lfoGain.connect(g.gain);
  osc.connect(g); g.connect(masterGain);

  const now = AC.currentTime;
  g.gain.setValueAtTime(0.0, now);
  g.gain.linearRampToValueAtTime(0.2, now+0.25);

  osc.start(); lfo.start();
  purrNode = {osc,lfo}; purrGain = g;
}
function stopPurr(){
  if(!purrNode) return;
  const now = AC.currentTime;
  try{
    purrGain.gain.cancelScheduledValues(now);
    purrGain.gain.linearRampToValueAtTime(0.0001, now+0.2);
    setTimeout(()=>{
      try{ purrNode.osc.stop(); purrNode.lfo.stop(); }catch(_){}
      purrNode=null; purrGain=null;
    }, 220);
  }catch(_){ purrNode=null; purrGain=null; }
}

/* ===================== 액션 ===================== */
function feed(){
  applyTimeDecay();
  change("hunger", +22); change("happy", +5); change("energy", +2); gainXP(6);
  setStatus("맛있는 밥 냠냠! 🍚"); playTone([523,659,784],0.09);
  spawnParticles("🍚 ❤️", 10);
  render(); save();
}
function play(){
  applyTimeDecay();
  change("happy", +16); change("energy", -8); change("hunger", -6); gainXP(8);
  setStatus("공을 흔들며 신나게 놀아요 🎾"); playTone([784,880,988],0.08);
  spawnParticles("✨ ⭐️ 💫", 12);
  render(); save();
}
function sleep(){
  applyTimeDecay();
  change("energy", +24); change("hunger", -8); gainXP(4);
  setStatus("포근한 낮잠을 자는 중이에요 💤"); playTone([392,329,261],0.12);
  spawnParticles("💤 🌙", 8);
  render(); save();
}
function renamePet(){
  const name = prompt("고양이 이름을 지어주세요", S.name||"냥냥이");
  if(name && name.trim()){
    S.name = name.trim();
    setStatus(`이름이 '${S.name}'(으)로 바뀌었어요 ✏️`);
    render(); save();
  }
}
function resetPet(){
  if(confirm("정말 초기화할까요? 저장된 진행 상황이 삭제됩니다.")){
    S = defaultState();
    setStatus("새로운 모험을 시작해요 ✨");
    render(); save();
  }
}
function exportSave(){
  document.getElementById("saveArea").value = JSON.stringify(S);
  toast("저장 데이터를 내보냈어요 💾");
}
function importSave(){
  try{
    const t=document.getElementById("saveArea").value.trim();
    if(!t) return alert("불러올 JSON을 붙여넣어 주세요.");
    const obj=JSON.parse(t);
    S = { ...defaultState(), ...obj, settings:{...defaultState().settings, ...(obj.settings||{})}};
    setStatus("저장 데이터를 불러왔어요 📂");
    render(); save();
  }catch(e){ alert("불러오기 실패: 올바른 JSON이 아니에요."); }
}

/* ===================== 조언(비복원 랜덤) ===================== */
const advices = [
  "마음속으로 고민을 살짝 올려두고, 숨을 한 번 고르세요.",
  "오늘은 답을 찾기보다, 스스로에게 작은 휴식을 선물하세요.",
  "길을 잃은 것 같아도, 그 길 위에서 배우는 게 있습니다.",
  "문제는 생각보다 단순할 수 있어요. 마음을 가볍게 해보세요.",
  "당신이 내딛는 작은 발걸음이 내일의 큰 용기를 만듭니다.",
  "서두르지 않아도 괜찮습니다. 기다림이 가장 빠른 길이 될 때가 있어요.",
  "고양이처럼 유연하게, 상황에 몸을 맡겨보세요.",
  "외로움 속에서도 누군가는 당신을 응원하고 있습니다.",
  "선택이 어렵다면, 지금 마음이 가장 편안해지는 쪽을 택하세요.",
  "고개를 들어 하늘을 바라보세요. 답은 가까운 곳에 있어요.",
  "지금의 고민은 언젠가 웃으며 이야기할 추억이 됩니다.",
  "완벽할 필요 없어요. 지금의 당신 그대로 충분합니다.",
  "한 걸음 물러서면 새로운 풍경이 보일 거예요.",
  "실패는 끝이 아니라, 더 나은 방법을 알려주는 안내서랍니다.",
  "지금은 멈춰도 괜찮아요. 고양이도 낮잠이 필요하니까요.",
  "용기가 크지 않아도 돼요. 아주 작은 용기 하나면 충분합니다.",
  "웃음을 잃지 않는다면, 어떤 어려움도 지나갈 거예요.",
  "손 내밀면 도움은 의외로 가까이 있습니다.",
  "고양이 발자국처럼, 당신의 흔적도 누군가에게 위로가 됩니다.",
  "답을 정하려 애쓰지 말고, 답이 스스로 다가오도록 기다려보세요.",
  "결국 모든 것은 잘 흘러가고, 당신은 웃게 될 거예요.",
  "마음을 다잡는 데는 긴 시간이 필요하지 않습니다.",
  "지금의 고요가 내일의 힘이 됩니다.",
  "괜찮다고 스스로에게 말해보세요. 생각보다 큰 위로가 됩니다.",
  "놓아야 할 때는 손을 놓는 것도 지혜입니다.",
  "해답은 멀리 있지 않고, 이미 당신 안에 있습니다.",
  "새벽은 언제나 어둠 뒤에 찾아옵니다.",
  "오늘의 고민은 내일의 지혜가 됩니다.",
  "다가올 일을 두려워하지 마세요. 준비되지 않아도 괜찮습니다.",
  "한 번의 멈춤은 실패가 아니라 충전입니다.",
  "작은 기쁨이 큰 슬픔을 이깁니다.",
  "오늘의 선택이 내일의 기적을 만듭니다.",
  "기대하지 않았던 곳에서 길이 열립니다.",
  "혼자가 아니에요. 당신을 생각하는 이가 있습니다.",
  "답이 보이지 않을 땐, 잠시 눈을 감아보세요.",
  "지금의 당신은 충분히 잘하고 있습니다.",
  "마음이 흔들릴 땐, 잠시 바람에 몸을 맡기세요.",
  "답은 선명하지 않아도, 방향은 보일 것입니다.",
  "가끔은 모르는 채로 두는 것도 방법입니다.",
  "힘들수록 작은 즐거움을 찾아보세요.",
  "답이 늦게 오는 건, 더 좋은 길을 준비하고 있기 때문입니다.",
  "지금 느끼는 혼란도 언젠가 정리됩니다.",
  "고통은 잠시지만, 배움은 오래 남습니다.",
  "포기하고 싶을 때가 곧 변곡점입니다.",
  "당신이 원하는 삶은 이미 당신을 향해 오고 있습니다.",
  "답은 당신의 일상 속에 숨어 있습니다.",
  "웃음은 모든 상처를 치유하는 약입니다.",
  "천천히 가도 괜찮습니다. 결국 도착할 수 있습니다.",
  "당신이 가진 친절은 반드시 돌아옵니다.",
  "오늘의 한숨은 내일의 웃음이 됩니다."
];
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function drawAdvice(){
  if(!Array.isArray(S.advicePool) || S.advicePool.length===0){ S.advicePool = shuffle([...advices]); }
  const msg = S.advicePool.pop();
  const box = document.getElementById("advice");
  box.classList.remove("fade-in"); box.classList.add("fade-out");
  setTimeout(()=>{ box.textContent = "🐾 " + msg; box.classList.remove("fade-out"); box.classList.add("fade-in"); }, 120);
  save(); if(S.settings.sound){ beep(520,0.08); }
}

/* ===================== 렌더/UI & 아트 ===================== */
function setBar(id, val){ document.getElementById(id).style.width = clamp(val) + "%"; }
function setStatus(t){ document.getElementById("statusLine").textContent = t; }
function moodFaceEmoji(){
  const a = avgStat();
  if(a>=85) return "😻"; if(a>=65) return "😺"; if(a>=45) return "😼"; if(a>=25) return "😿"; return "😾";
}
function renderBars(){
  document.getElementById("valHunger").textContent=S.hunger;
  document.getElementById("valHappy").textContent=S.happy;
  document.getElementById("valEnergy").textContent=S.energy;
  document.getElementById("valLevel").textContent=`Lv ${S.level}`;
  setBar("barHunger",S.hunger); setBar("barHappy",S.happy); setBar("barEnergy",S.energy); setBar("barXP",S.xp%100);

  const a = avgStat();
  if(a>=75) setStatus("반짝이는 눈으로 당신을 바라봅니다 ✨");
  else if(a>=55) setStatus("기분 좋은 가르랑 소리가 들려요 😺");
  else if(a>=35) setStatus("살짝 시무룩해요… 쓰담쓰담이 필요해요 🌥️");
  else setStatus("배고프고 지친 표정이에요… 돌봄이 필요해요 🌧️");

  // Purr 자동 제어
  if(S.settings.sound && a>=60) startPurr(); else stopPurr();
}
function computedTheme(){
  if(S.settings.theme==="day") return "day";
  if(S.settings.theme==="night") return "night";
  const h = new Date().getHours(); return (h>=19 || h<6) ? "night" : "day";
}
function renderTheme(){
  const isNight = computedTheme()==="night";
  document.body.classList.toggle("is-night", isNight);
  document.body.style.background = isNight
    ? `linear-gradient(135deg, var(--night1), var(--night2))`
    : `linear-gradient(135deg, var(--day1), var(--day2))`;
}
function renderStars(){
  const cont = document.getElementById("stars"); cont.innerHTML="";
  if(computedTheme()!=="night") return;
  const N = 90;
  for(let i=0;i<N;i++){
    const s=document.createElement("div"); s.className="star";
    s.style.left = Math.random()*100+"%"; s.style.top  = Math.random()*100+"%";
    s.style.opacity = (0.4+Math.random()*0.6).toFixed(2);
    s.style.transform = `scale(${0.8+Math.random()*1.8})`;
    cont.appendChild(s);
  }
}
/* 스킨별 SVG: 낮/밤/성장(kitten/adult/boss) 색상 변화 */
function svgSimple(colorBase, colorEar, mouthY){
  return `
  <svg class="svgcat" viewBox="0 0 120 120" aria-label="cat simple">
    <circle cx="60" cy="65" r="36" fill="${colorBase}" stroke="#333" stroke-width="3"/>
    <path d="M34 42 L20 20 L44 30 Z" fill="${colorEar}" stroke="#333" stroke-width="3"/>
    <path d="M86 42 L100 20 L76 30 Z" fill="${colorEar}" stroke="#333" stroke-width="3"/>
    <circle cx="48" cy="66" r="4" fill="#333"/>
    <circle cx="72" cy="66" r="4" fill="#333"/>
    <circle cx="60" cy="${mouthY}" r="3" fill="#ff5a7a"/>
    <path d="M45 84 Q60 92 75 84" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round"/>
    <path d="M60 ${mouthY} L52 ${mouthY} M60 ${mouthY} L68 ${mouthY}" stroke="#333" stroke-width="2" stroke-linecap="round"/>
  </svg>`;
}
function svgChonky(colorBody, colorHead, moodCurve){
  return `
  <svg class="svgcat" viewBox="0 0 120 120" aria-label="cat chonky">
    <ellipse cx="60" cy="74" rx="40" ry="34" fill="${colorBody}" stroke="#333" stroke-width="3"/>
    <circle cx="60" cy="55" r="22" fill="${colorHead}" stroke="#333" stroke-width="3"/>
    <path d="M43 46 L30 30 L50 36 Z" fill="${colorHead}" stroke="#333" stroke-width="3"/>
    <path d="M77 46 L90 30 L70 36 Z" fill="${colorHead}" stroke="#333" stroke-width="3"/>
    <circle cx="52" cy="56" r="3.5" fill="#333"/>
    <circle cx="68" cy="56" r="3.5" fill="#333"/>
    <path d="${moodCurve}" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round"/>
    <circle cx="60" cy="62" r="3" fill="#ff7b54"/>
    <path d="M60 62 L53 62 M60 62 L67 62" stroke="#333" stroke-width="2" stroke-linecap="round"/>
  </svg>`;
}
function renderAvatar(){
  const wrap = document.getElementById("avatar");
  wrap.innerHTML = "";
  const theme = computedTheme();
  const stg = stage();
  if(S.settings.skin==="emoji"){
    const d=document.createElement("div"); d.className="face"; d.id="face"; d.textContent=moodFaceEmoji();
    wrap.appendChild(d);
    return;
  }
  if(S.settings.skin==="simple"){
    // 색상: 낮/밤/성장
    const baseDay = stg==="kitten" ? "#FFD6E7" : stg==="adult" ? "#FFE6A7" : "#C4F1BE";
    const baseNight = stg==="kitten" ? "#DFAFD0" : stg==="adult" ? "#E2CF8A" : "#A7E0A4";
    const earDay = "#fff"; const earNight="#eee";
    const colorBase = theme==="night" ? baseNight : baseDay;
    const colorEar  = theme==="night" ? earNight  : earDay;
    const mouthY = 76 + (avgStat()<45 ? 2 : 0);
    wrap.innerHTML = svgSimple(colorBase, colorEar, mouthY);
    return;
  }
  // chonky
  const bodyDay = stg==="kitten" ? "#FFE9B3" : stg==="adult" ? "#BEE3F8" : "#C6F6D5";
  const headDay = stg==="kitten" ? "#FFE9B3" : stg==="adult" ? "#90CDF4" : "#9AE6B4";
  const bodyNight= stg==="kitten" ? "#E8D39A" : stg==="adult" ? "#8CB8E0" : "#99D9B6";
  const headNight= stg==="kitten" ? "#E8D39A" : stg==="adult" ? "#7AA7D3" : "#82CAA5";
  const isNight = theme==="night";
  const curveHappy = "M52 66 Q60 72 68 66";
  const curveFlat  = "M52 68 Q60 68 68 68";
  const moodCurve = avgStat()>=60 ? curveHappy : curveFlat;
  wrap.innerHTML = svgChonky(isNight?bodyNight:bodyDay, isNight?headNight:headDay, moodCurve);
}

function renderThemeAndStars(){ renderTheme(); renderStars(); }

/* ===================== 파티클 ===================== */
function spawnParticles(chars="✨", count=10){
  const avatar = document.getElementById("avatar");
  const rect = avatar.getBoundingClientRect();
  for(let i=0;i<count;i++){
    const p = document.createElement("div");
    p.className="particle";
    const arr = chars.split(" ").filter(Boolean);
    p.textContent = arr[Math.floor(Math.random()*arr.length)];
    const x = rect.left + rect.width/2 + (Math.random()*30-15);
    const y = rect.top  + rect.height/2 + (Math.random()*10-5);
    p.style.left = x+"px";
    p.style.top  = y+"px";
    const dx = (Math.random()*80-40)+"px";
    const dy = (-60 - Math.random()*40)+"px";
    p.style.setProperty("--dx", dx);
    p.style.setProperty("--dy", dy);
    document.body.appendChild(p);
    setTimeout(()=>p.remove(), 900);
  }
}

/* ===================== 이벤트/설정 바인딩 ===================== */
document.getElementById("skinSelect").value = S.settings.skin;
document.getElementById("themeSelect").value = S.settings.theme;
document.getElementById("skinSelect").addEventListener("change", e=>{
  S.settings.skin = e.target.value; renderAvatar(); save();
});
document.getElementById("themeSelect").addEventListener("change", e=>{
  S.settings.theme = e.target.value; renderThemeAndStars(); renderAvatar(); save();
});
const soundChip = document.getElementById("soundChip");
function updateSoundChip(){
  soundChip.classList.toggle("active", !!S.settings.sound);
  soundChip.textContent = S.settings.sound ? "🔊 사운드 ON" : "🔇 사운드 OFF";
  soundChip.setAttribute("aria-pressed", S.settings.sound ? "true":"false");
  if(!S.settings.sound) stopPurr(); else { /* 클릭 즉시 확인용 */ ensureAudio(); beep(660,0.08); }
}
soundChip.addEventListener("click", ()=>{
  S.settings.sound = !S.settings.sound;
  updateSoundChip(); save();
});

/* ===================== 공용 렌더 & 초기화 ===================== */
function render(){
  document.getElementById("petName").textContent = S.name || "냥냥이";
  const faceEl = document.getElementById("face");
  if(faceEl) faceEl.textContent = moodFaceEmoji();
  renderBars(); renderThemeAndStars(); renderAvatar(); updateSoundChip();
}
function tick(){ applyTimeDecay(); render(); save(); }

/* 토스트 */
let toastTimer=null;
function toast(msg){
  const t=document.createElement("div");
  t.textContent = msg;
  t.style.position="fixed"; t.style.left="50%"; t.style.bottom="24px"; t.style.transform="translateX(-50%)";
  t.style.background="#111"; t.style.color="#fff"; t.style.padding="10px 14px"; t.style.borderRadius="999px";
  t.style.boxShadow="0 8px 18px rgba(0,0,0,.25)"; t.style.fontSize=".95rem"; t.style.zIndex=9999; t.style.opacity="0";
  document.body.appendChild(t);
  requestAnimationFrame(()=>{ t.style.transition="opacity .25s ease, transform .25s ease"; t.style.opacity="1"; t.style.transform="translateX(-50%) translateY(-4px)";});
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateX(-50%) translateY(0)"; setTimeout(()=>t.remove(),250); },1700);
}

/* 초기 실행 */
applyTimeDecay();
render();
setInterval(tick, 15000);
</script>
</body>
</html>
